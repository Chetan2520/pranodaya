<?php

/**
 * Bootstrap file for Pranodaya application
 * Initializes environment, logging, and core application components
 */

// Define root directory constant
define('ROOT_DIR', __DIR__);

// Load Composer autoloader
require_once ROOT_DIR . '/vendor/autoload.php';

// Load environment variables
try {
    $dotenv = Dotenv\Dotenv::createImmutable(ROOT_DIR);
    $dotenv->load(); } catch (Exception $e) { // If .env file doesn't exist,
create it from example if (file_exists(ROOT_DIR . '/.env.example')) {
copy(ROOT_DIR . '/.env.example', ROOT_DIR . '/.env'); $dotenv =
Dotenv\Dotenv::createImmutable(ROOT_DIR); $dotenv->load(); } } // Initialize
logging try { // Create logs directory if it doesn't exist $logDir = ROOT_DIR .
'/storage/logs'; if (!is_dir($logDir)) { mkdir($logDir, 0755, true); } // Create
logger instance $logger = new Monolog\Logger('Pranodaya'); // Set log level from
environment or default to INFO $logLevel = $_ENV['LOG_LEVEL'] ?? 'info';
$logLevel = constant('Monolog\Logger::' . strtoupper($logLevel)); // Create file
handler $logFile = $_ENV['LOG_FILE'] ?? 'storage/logs/app.log'; $fileHandler =
new Monolog\Handler\RotatingFileHandler( ROOT_DIR . '/' . $logFile, 30, // Keep
30 days of logs $logLevel ); // Create line formatter for better log formatting
$formatter = new Monolog\Formatter\LineFormatter( "[%datetime%]
%channel%.%level_name%: %message% %context% %extra%\n", "Y-m-d H:i:s", true, //
Allow inline line breaks true // Ignore empty context and extra );
$fileHandler->setFormatter($formatter); // Add handler to logger
$logger->pushHandler($fileHandler); // Add console handler for development if
($_ENV['APP_ENV'] ?? 'production' !== 'production') { $consoleHandler = new
Monolog\Handler\StreamHandler('php://stdout', $logLevel);
$consoleHandler->setFormatter($formatter);
$logger->pushHandler($consoleHandler); } // Make logger globally available
$GLOBALS['logger'] = $logger; // Log application start $logger->info('Pranodaya
application started', [ 'environment' => $_ENV['APP_ENV'] ?? 'production',
'version' => '1.0.0', 'php_version' => PHP_VERSION ]); } catch (Exception $e) {
// Fallback if logging fails error_log('Failed to initialize logger: ' .
$e->getMessage()); $GLOBALS['logger'] = null; } /** * Global logging function
for easy access throughout the application * * @param string $level Log level
(debug, info, notice, warning, error, critical, alert, emergency) * @param
string $message Log message * @param array $context Additional context data */
function log_message($level, $message, $context = []) { $logger =
$GLOBALS['logger']; if ($logger instanceof Monolog\Logger) {
$logger->$level($message, $context); } else { // Fallback to error_log if logger
is not available error_log("[$level] $message " . json_encode($context)); } }
/** * Convenience functions for common log levels */ function
log_debug($message, $context = []) { log_message('debug', $message, $context); }
function log_info($message, $context = []) { log_message('info', $message,
$context); } function log_warning($message, $context = []) {
log_message('warning', $message, $context); } function log_error($message,
$context = []) { log_message('error', $message, $context); } function
log_critical($message, $context = []) { log_message('critical', $message,
$context); } // Set PHP error reporting based on environment if
($_ENV['APP_DEBUG'] ?? false) { error_reporting(E_ALL);
ini_set('display_errors', 1); ini_set('log_errors', 1); ini_set('error_log',
ROOT_DIR . '/storage/logs/php_errors.log'); } else { error_reporting(E_ERROR |
E_PARSE); ini_set('display_errors', 0); ini_set('log_errors', 1);
ini_set('error_log', ROOT_DIR . '/storage/logs/php_errors.log'); } // Set
timezone if specified in environment if (isset($_ENV['APP_TIMEZONE'])) {
date_default_timezone_set($_ENV['APP_TIMEZONE']); } /** * Session Management
Configuration * Secure session handling with environment-based configuration */
// Initialize session with security settings function initialize_session() { //
Set session configuration before starting session $session_lifetime =
(int)($_ENV['SESSION_LIFETIME'] ?? 7200); // Default 2 hours $session_secure =
filter_var($_ENV['SESSION_SECURE_COOKIE'] ?? true, FILTER_VALIDATE_BOOLEAN);
$session_http_only = filter_var($_ENV['SESSION_HTTP_ONLY'] ?? true,
FILTER_VALIDATE_BOOLEAN); $session_encrypt =
filter_var($_ENV['SESSION_ENCRYPT_COOKIE'] ?? true, FILTER_VALIDATE_BOOLEAN);
$session_same_site = $_ENV['SESSION_SAME_SITE'] ?? 'strict'; // Set session
cookie parameters session_set_cookie_params([ 'lifetime' => $session_lifetime,
'path' => '/', 'domain' => $_ENV['SESSION_DOMAIN'] ?? $_SERVER['HTTP_HOST'] ??
'', 'secure' => $session_secure, 'httponly' => $session_http_only, 'samesite' =>
$session_same_site ]); // Set session configuration
ini_set('session.gc_maxlifetime', $session_lifetime);
ini_set('session.cookie_lifetime', $session_lifetime); // Start the session if
(session_status() === PHP_SESSION_NONE) { session_start(); } // Regenerate
session ID for security if (!isset($_SESSION['session_initialized'])) {
session_regenerate_id(true); $_SESSION['session_initialized'] = true;
$_SESSION['session_start_time'] = time(); $_SESSION['user_ip'] =
$_SERVER['REMOTE_ADDR'] ?? 'unknown'; $_SESSION['user_agent'] =
$_SERVER['HTTP_USER_AGENT'] ?? 'unknown'; log_info('Session initialized', [
'session_id' => session_id(), 'ip' => $_SESSION['user_ip'], 'user_agent' =>
$_SESSION['user_agent'], 'lifetime' => $session_lifetime ]); } // Validate
session for security validate_session(); } /** * Validate current session for
security threats */ function validate_session() { $current_time = time();
$session_start = $_SESSION['session_start_time'] ?? 0; $session_lifetime =
(int)($_ENV['SESSION_LIFETIME'] ?? 7200); // Check if session has expired if
(($current_time - $session_start) > $session_lifetime) { log_warning('Session
expired, destroying', [ 'session_id' => session_id(), 'age' => $current_time -
$session_start, 'lifetime' => $session_lifetime ]); destroy_session(); return; }
// Check for IP mismatch (optional security measure) $original_ip =
$_SESSION['user_ip'] ?? ''; $current_ip = $_SERVER['REMOTE_ADDR'] ?? ''; if
(!empty($original_ip) && $original_ip !== $current_ip) { log_warning('Session IP
mismatch detected', [ 'session_id' => session_id(), 'original_ip' =>
$original_ip, 'current_ip' => $current_ip, 'user_agent' =>
$_SESSION['user_agent'] ?? 'unknown' ]); // For strict security, you might want
to destroy the session // destroy_session(); } // Update last activity
$_SESSION['last_activity'] = $current_time; } /** * Destroy current session
securely */ function destroy_session() { $session_id = session_id(); // Clear
session data $_SESSION = []; // Destroy session cookie if
(isset($_COOKIE[session_name()])) { setcookie( session_name(), '', time() -
42000, '/', $_ENV['SESSION_DOMAIN'] ?? $_SERVER['HTTP_HOST'] ?? '',
filter_var($_ENV['SESSION_SECURE_COOKIE'] ?? true, FILTER_VALIDATE_BOOLEAN),
filter_var($_ENV['SESSION_HTTP_ONLY'] ?? true, FILTER_VALIDATE_BOOLEAN) ); } //
Destroy session session_destroy(); log_info('Session destroyed', [ 'session_id'
=> $session_id, 'reason' => 'manual_destroy' ]); } /** * Session helper
functions for common operations */ /** * Set session variable with logging */
function set_session($key, $value) { $_SESSION[$key] = $value;
log_debug('Session variable set', [ 'session_id' => session_id(), 'key' => $key,
'value_type' => gettype($value) ]); return true; } /** * Get session variable
with logging */ function get_session($key, $default = null) { $value =
$_SESSION[$key] ?? $default; log_debug('Session variable accessed', [
'session_id' => session_id(), 'key' => $key, 'found' => isset($_SESSION[$key])
]); return $value; } /** * Check if user is authenticated (placeholder for
future auth system) */ function is_authenticated() { return
isset($_SESSION['authenticated']) && $_SESSION['authenticated'] === true; } /**
* Check if user has specific permission (placeholder for future auth system) */
function has_permission($permission) { return isset($_SESSION['permissions']) &&
in_array($permission, $_SESSION['permissions']); } /** * Get user role
(placeholder for future auth system) */ function get_user_role() { return
$_SESSION['user_role'] ?? 'guest'; } /** * Flash message helper functions */
function set_flash_message($type, $message) { $_SESSION['flash_messages'][] = [
'type' => $type, 'message' => $message, 'timestamp' => time() ]; } function
get_flash_messages() { $messages = $_SESSION['flash_messages'] ?? [];
unset($_SESSION['flash_messages']); // Clear after retrieving return $messages;
} function has_flash_messages() { return !empty($_SESSION['flash_messages']); }
// Initialize session management initialize_session(); // Security headers for
production if ($_ENV['APP_ENV'] ?? 'production' === 'production') { // Set
secure headers if (!headers_sent()) { header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY'); header('X-XSS-Protection: 1; mode=block');
header('Referrer-Policy: strict-origin-when-cross-origin'); }
log_info('Production security headers set'); }
